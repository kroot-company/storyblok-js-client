/*!
 * storyblok-js-client v0.0.0-development
 * Universal JavaScript SDK for Storyblok's API
 * (c) 2020-2021 Stobylok Team
 */
"use strict";var e=require("qs"),t=require("axios");function r(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function s(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var s=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,s.get?s:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}var n=s(e),a=r(t);function i(e){return"number"==typeof e&&(e==e&&e!==1/0&&e!==-1/0)}function o(e,t,r){if(!i(t))throw new TypeError("Expected `limit` to be a finite number");if(!i(r))throw new TypeError("Expected `interval` to be a finite number");var s=[],n=[],a=0,o=function(){a++;var t=setTimeout((function(){a--,s.length>0&&o(),n=n.filter((function(e){return e!==t}))}),r);n.indexOf(t)<0&&n.push(t);var i=s.shift();i.resolve(e.apply(i.self,i.args))},c=function(){var e=arguments,r=this;return new Promise((function(n,i){s.push({resolve:n,reject:i,args:e,self:r}),a<t&&o()}))};return c.abort=function(){n.forEach(clearTimeout),n=[],s.forEach((function(e){e.reject(new throttle.AbortError)})),s.length=0},c}o.AbortError=function(){Error.call(this,"Throttled function aborted"),this.name="AbortError"};const c=function(e,t){if(!e)return null;let r={};for(let s in e){let n=e[s];t.indexOf(s)>-1&&null!==n&&(r[s]=n)}return r};var h={nodes:{horizontal_rule:e=>({singleTag:"hr"}),blockquote:e=>({tag:"blockquote"}),bullet_list:e=>({tag:"ul"}),code_block:e=>({tag:["pre",{tag:"code",attrs:e.attrs}]}),hard_break:e=>({singleTag:"br"}),heading:e=>({tag:"h"+e.attrs.level}),image:e=>({singleTag:[{tag:"img",attrs:c(e.attrs,["src","alt","title"])}]}),list_item:e=>({tag:"li"}),ordered_list:e=>({tag:"ol"}),paragraph:e=>({tag:"p"})},marks:{bold:()=>({tag:"b"}),strike:()=>({tag:"strike"}),underline:()=>({tag:"u"}),strong:()=>({tag:"strong"}),code:()=>({tag:"code"}),italic:()=>({tag:"i"}),link(e){const t={...e.attrs},{linktype:r="url"}=e.attrs;return"email"===r&&(t.href="mailto:"+t.href),t.anchor&&(t.href=`${t.href}#${t.anchor}`,delete t.anchor),{tag:[{tag:"a",attrs:t}]}},styled:e=>({tag:[{tag:"span",attrs:e.attrs}]})}};class l{constructor(e){e||(e=h),this.marks=e.marks||[],this.nodes=e.nodes||[]}addNode(e,t){this.nodes[e]=t}addMark(e,t){this.marks[e]=t}render(e={}){if(e.content&&Array.isArray(e.content)){let t="";return e.content.forEach(e=>{t+=this.renderNode(e)}),t}return console.warn("The render method must receive an object with a content field, which is an array"),""}renderNode(e){let t=[];e.marks&&e.marks.forEach(e=>{const r=this.getMatchingMark(e);r&&t.push(this.renderOpeningTag(r.tag))});const r=this.getMatchingNode(e);return r&&r.tag&&t.push(this.renderOpeningTag(r.tag)),e.content?e.content.forEach(e=>{t.push(this.renderNode(e))}):e.text?t.push(function(e){const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},r=/[&<>"']/g,s=RegExp(r.source);return e&&s.test(e)?e.replace(r,e=>t[e]):e}(e.text)):r&&r.singleTag?t.push(this.renderTag(r.singleTag," /")):r&&r.html&&t.push(r.html),r&&r.tag&&t.push(this.renderClosingTag(r.tag)),e.marks&&e.marks.slice(0).reverse().forEach(e=>{const r=this.getMatchingMark(e);r&&t.push(this.renderClosingTag(r.tag))}),t.join("")}renderTag(e,t){if(e.constructor===String)return`<${e}${t}>`;return e.map(e=>{if(e.constructor===String)return`<${e}${t}>`;{let r="<"+e.tag;if(e.attrs)for(let t in e.attrs){let s=e.attrs[t];null!==s&&(r+=` ${t}="${s}"`)}return`${r}${t}>`}}).join("")}renderOpeningTag(e){return this.renderTag(e,"")}renderClosingTag(e){if(e.constructor===String)return`</${e}>`;return e.slice(0).reverse().map(e=>e.constructor===String?`</${e}>`:`</${e.tag}>`).join("")}getMatchingNode(e){if("function"==typeof this.nodes[e.type])return this.nodes[e.type](e)}getMatchingMark(e){if("function"==typeof this.marks[e.type])return this.marks[e.type](e)}}const u=(e=0,t=e)=>{const r=Math.abs(t-e)||0,s=e<t?1:-1;return((e=0,t)=>[...Array(e)].map(t))(r,(t,r)=>r*s+e)},{stringify:g}=n;let p={};module.exports=class{constructor(e,t){if(!t){let r=e.region?"-"+e.region:"";t=`${!1===e.https?"http":"https"}://api${r}.storyblok.com/v1`}let r=Object.assign({},e.headers),s=5;void 0!==e.oauthToken&&(r.Authorization=e.oauthToken,s=3),void 0!==e.rateLimit&&(s=e.rateLimit),this.richTextResolver=new l(e.richTextSchema),"function"==typeof e.componentResolver&&this.setComponentResolver(e.componentResolver),this.maxRetries=e.maxRetries||5,this.throttle=o(this.throttledRequest,s,1e3),this.cacheVersion=this.cacheVersion||this.newVersion(),this.accessToken=e.accessToken,this.cache=e.cache||{clear:"manual"},this.client=a.default.create({baseURL:t,timeout:e.timeout||0,headers:r,proxy:e.proxy||!1}),e.responseInterceptor&&this.client.interceptors.response.use(t=>e.responseInterceptor(t))}setComponentResolver(e){this.richTextResolver.addNode("blok",t=>{let r="";return t.attrs.body.forEach(t=>{r+=e(t.component,t)}),{html:r}})}parseParams(e={}){return e.version||(e.version="published"),e.cv||(e.cv=this.cacheVersion),e.token||(e.token=this.getToken()),e}factoryParamOptions(e,t={}){return((e="")=>e.indexOf("/cdn/")>-1)(e)?this.parseParams(t):t}makeRequest(e,t,r,s){const n=this.factoryParamOptions(e,((e={},t=25,r=1)=>({...e,per_page:t,page:r}))(t,r,s));return this.cacheResponse(e,n)}get(e,t){let r="/"+e;const s=this.factoryParamOptions(r,t);return this.cacheResponse(r,s)}async getAll(e,t={},r){const s=t.per_page||25,n="/"+e,a=n.split("/");r=r||a[a.length-1];const i=await this.makeRequest(n,t,s,1),o=Math.ceil(i.total/s);return((e=[],t)=>e.map(t).reduce((e,t)=>[...e,...t],[]))([i,...await(async(e=[],t)=>Promise.all(e.map(t)))(u(1,o),async e=>this.makeRequest(n,t,s,e+1))],e=>Object.values(e.data[r]))}post(e,t){let r="/"+e;return this.throttle("post",r,t)}put(e,t){let r="/"+e;return this.throttle("put",r,t)}delete(e,t){let r="/"+e;return this.throttle("delete",r,t)}getStories(e){return this.get("cdn/stories",e)}getStory(e,t){return this.get("cdn/stories/"+e,t)}setToken(e){this.accessToken=e}getToken(){return this.accessToken}cacheResponse(e,t,r){return void 0===r&&(r=0),new Promise(async(s,n)=>{let a=g({url:e,params:t},{arrayFormat:"brackets"}),i=this.cacheProvider();if("auto"===this.cache.clear&&"draft"===t.version&&await this.flushCache(),"published"===t.version&&"/cdn/spaces/me"!=e){const e=await i.get(a);if(e)return s(e)}try{let r=await this.throttle("get",e,{params:t,paramsSerializer:e=>g(e,{arrayFormat:"brackets"})}),o={data:r.data,headers:r.headers};if(r.headers["per-page"]&&(o=Object.assign({},o,{perPage:parseInt(r.headers["per-page"]),total:parseInt(r.headers.total)})),200!=r.status)return n(r);"published"===t.version&&"/cdn/spaces/me"!=e&&i.set(a,o),s(o)}catch(a){if(a.response&&429===a.response.status&&(r+=1)<this.maxRetries)return console.log(`Hit rate limit. Retrying in ${r} seconds.`),await(o=1e3*r,new Promise(e=>setTimeout(e,o))),this.cacheResponse(e,t,r).then(s).catch(n);n(a)}var o})}throttledRequest(e,t,r){return this.client[e](t,r)}newVersion(){return(new Date).getTime()}cacheProvider(){switch(this.cache.type){case"memory":return{get:e=>p[e],getAll:()=>p,set(e,t){p[e]=t},flush(){p={}}};default:return this.cacheVersion=this.newVersion(),{get(){},getAll(){},set(){},flush(){}}}}async flushCache(){return this.cacheVersion=this.newVersion(),await this.cacheProvider().flush(),this}};
